# Integrating Finsemble auth with Keycloak

This recipe intends to provide an example for integrating Keycloak with Finsemble for authentication.

## Installing KeyCloak

* Please download Keycloak from https://www.keycloak.org/downloads.html and install it with your decided environment.
* Follow their instruction (https://www.keycloak.org/getting-started) to start and configure your Keycloak server base on your runtime environment.
  * You need to configure your `Valid Redirect URIs` in your KeyCloak client to point to your Finsemble auth component. (i.e In this recipe `http://localhost:3375/components/keycloakResponse/keycloakResponse.html`)
* Record down the following values while you are setting up KeyCloak for configuring Finsemble to connect KeyCloak

  * Server Address
  * Realm Id
  * Client Id
* Create a testing user

## Configure Finsemble

### Enabling Authentication

To use Keycloak in Finsemble, you have to enable authentication in `config.json`. You have to add `authentication` attribute. Please see the example in `config.json` and the following.

```javascript
"authentication": {
    "startup": {
        //Default adapter to use
        "adapter": "OAUTH2",
        // The authenication endpoint provided by Keycloak, for exact endpoint, please check your own Keycloak setting or their reference material
        "authorization_endpoint": "http://<-- Your Keycloak server address -->:<-- Your Keycloak server port -->/auth/realms/<-- You realm id -->/protocol/openid-connect/auth",
        "scope": "openid",
        // The Keycloak clientid you setup in Keylcoak
        "client_id": "<-- Your Keycloak client ID -->",
        // Your server API to handle the auth code sent from Keycloak to retrieve the access token
        // In this recipe the example code is in server/server.js
        "backchannel_endpoint": "<-- Your backchannel API-->",
        // The page should be redirected to after authenication
        // This page will then pass the auth code from keycloak to the backchannel endpoint
        "redirect_uri": "$applicationRoot/components/keycloakResponse/keycloakResponse.html",
        // The auth component
        "component": "keycloakResponse"
    }
}
```

### Authentication flow

1. The startup of Finsemble will be paused if authentication is enabled in `config.json`. A `keycloakResponse` component will be spawned and redirected to the `authorization_endpoint` you set in `config.json` for authentication.

2. After the successful authentication, the `Valid Redirect URIs` will be called with an auth code and the `keycloakResponse` component will call your `backchannel` with the auth code to retrieve access token.

3. After receiving the access token, the `keycloakResponse` component will execute `publishAuthorization()` to complete the startup process.

### keycloakResponse

This component is used to handle the auth code sent from Keycloak after correct authentication. The auth code will be sent to the backchannel endpoint by calling `FSBL.Clients.AuthenticationClient.completeOAUTH()` to retrieve the access token. After that, you can add your own logic in the callback of `runBusinessLogic()` to set up your own credentials structure.

### backchannel_endpoint

This API must be set up in your own server to handle the auth code sent from Keycloak and send back the access token generated by KeyCloak. In this recipe, you can find the sample code in `server/server.js`. The auth code and related parameters will be sent to Keycloak's token endpoint to retrieve the access token.
